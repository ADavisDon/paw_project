<script>
  //Make a GET request to the collector to pull Title/Company/Quantity for the selected game title

  var gametitle

  $(document).ready(function(){

    $('#library_inventory_id').change(function() {
      gametitle = $('#library_inventory_id').val()

      $.ajax ({
        url: "list_game/" + gametitle,
        dataType: 'JSON',
        success: function(data){
          console.log(data);
          //Basic game info
          if ($('.display_game > tbody')[0].childElementCount > 1) {
            $('.display_game > tbody > tr:last').empty()
          };

          $('#library_quantity_left').val(data.logs.reverse()[0].quantity_left);

          $('.display_game > tbody:last').append('<tr><td>' + data.inventory[0].title + '</td><td>' + data.inventory[0].company + '</td><td>' + data.inventory[0].quantity_total + '</td></tr>');

          //Game schedule
          if ($('.display_schedule > tbody')[0].childElementCount > 1) {
            $('.display_schedule').find("tr:gt(0)").empty()
          };

          $.each ( $(data.schedule), function (i) {
            $('.display_schedule > tbody:last').append('<tr><td class="game_start">' + data.schedule[i].start + '</td><td>' + data.schedule[i].location + '</td><td>' + data.staff[i][0] + '</td></tr>' );
          });

          //Game logs
          if ($('.display_logs > tbody')[0].childElementCount > 1) {
            $('.display_logs > tbody > tr:last').empty()
          };

          $.each ( $(data.logs), function (i) {
            $('.display_logs').append('<tr><td>' + data.logs[i].checked_out + '</td><td>' + data.logs[i].checked_in + '</td><td><a href="javascript:void(0)" id="find_member">' + data.memberinfo[i][0].badge + '</a></td><td>' + data.logs[i].quantity_left);
          });

          $("a#find_member").click(function(){
            var badge_id = $(this)[0].innerHTML;

            $.ajax ({
              url: "list_member/" + badge_id,
              dataType: 'JSON',
              success: function(data){
                if ($('.contact_info > tbody')[0].childElementCount > 1) {
                  $('.contact_info').find("tr:gt(0)").empty()
                };

                $('.contact_info > tbody:last').append('<tr><td>' + data.member[0].name + '</td><td>' + data.member[0].phone + '</td><td>' + data.member[0].email + '</td><td>' + data.member[0].pref + '</td></tr>');
              }
            });
          });
        }
      });
    });
  });

</script>

<h1>Game Library</h1>

<%= render "shared/header" %>

<div id="library_notice"><%= notice %></div>

<%= form_for :library do |f| %>
  Game:
  <%= f.collection_select :inventory_id, @gameinfo, :id, :game_selection, options = {include_blank: "Select a game title" } %>
  <br><br>
  <div id="badge_entry">
    <%= f.collection_select :participant_id, Participant.all, :id, :badge_selection, prompt: "Enter badge" %>
  </div>
  <%= f.hidden_field :checked_out, :value => Time.now %>
  <%= f.hidden_field :checked_in, :value => Time.now %>
  <%= f.hidden_field :quantity_left %>
  <br>
  <div class="button"><%= f.submit 'Check-out' %>
  <%= f.submit 'Check-in', name: 'checkin_game', method: 'check_in' %></div>
  <br>
<%end%>

<h3>Game Information:</h3>
<div class="table"><table class="display_game">
  <tr>
    <th>Title</th>
    <th>Company</th>
    <th>Total Quantity</th>
  </tr>
</table></div><br>

<h3>Game Schedule:</h3>
<div class="table"><table class="display_schedule">
  <tr>
    <th>Start Time</th>
    <th>Location</th>
    <th>GM</th>
  </tr>
</table></div><br>

<h3>Checkout/in History:</h3>
<div class="table"><table class="display_logs">
  <tr>
    <th>Check-out Time</th>
    <th>Check-in Time</th>
    <th>Participant Name</th>
    <th>Quantity</th>
  </tr>
</table></div><br>

<h3>Contact Information: </h3>
<div class="table"><table class="contact_info">
  <tr>
    <th>Participant Name</th>
    <th>Phone</th>
    <th>Email</th>
    <th>Preference</th>
  </tr>
</table></div>