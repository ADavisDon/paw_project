<script>
  $(document).ready(function(){
    $('#pick_winners').click(function(){
      $.ajax ({
        url: "show_winners/",
        dataType: 'JSON',
        success: function(data){
          console.log(data);

          for (i = 0; i < (data.winners.length); i++) {
            //console.log($('[id$="_' + i + '"]'));

            console.log("Entry " + i + ": " + data.winners[i][0]);

            if (data.winners[i] != "No entry") {
              $('[id$="_' + (i + 1) + '"] > #winner_list').append('<li>Badge: ' + data.winners[i][0].badge + '</li><li>Name: ' + data.winners[i][0].name + '</li><li>Phone: ' + data.winners[i][0].phone + '</li><li>Email: ' + data.winners[i][0].email + '</li><li>Preference: ' + data.winners[i][0].pref + '</li><li>Rating: ' + data.winners[i][1][1] + '</li>');
              if (data.winners[i][0].proxy == true) {
                $('[id$="_' + i + '"] > #proxy_list').append('<li>Badge: ' + data.winners[i][0].p_badge + '</li><li>Name: ' + data.winners[i][0].p_name + '</li><li>Phone: ' + data.winners[i][0].p_phone + '</li><li>Email: ' + data.winners[i][0].p_email + '</li><li>Preference: ' + data.winners[i][0].p_pref + '</li>');
              }
            } else {
              $('[id$="_' + i + '"] > #winner_list').append('<li>No entries logged for this title.</li>');
            };
          }
        }
      });
    });

    $('.redraw').click(function(){
      var parent_td = this.closest('td').id.split('_')[1];

      $.ajax ({
        url: "redraw/" + this.id.slice(7),
        dataType: 'JSON',
        success: function(data){
          if (Object.keys(data) == "error"){
            $('.redraw_error')[parent_td - 1].innerHTML = data.error;
          } else
            console.log(data);
          }
      });
    });
  });
</script>

<h1>Winner Circle</h1>

<%= render "shared/header" %>

<button id="pick_winners">Pick the Winners!</button>

<table>
  <% Inventory.all.each_slice(4) do |rows| %>
    <tr>
      <% rows.each do |cells| %>
        <td id='<%= "#{cells.title}" %>_<%= "#{cells.id}" %>'>
          <div class="redraw_error"></div>
          <h4>Game Title:</h4>
          <div class="game_title"><%= "#{cells.title}" %></div>
          <h4>Winner:</h4>
          <ul id='winner_list'>
          </ul>
          <h4>Proxy info:</h4>
          <ul id='proxy_list'>
          </ul>
          <button class="redraw" id='submit_<%= "#{cells.id}" %>'>Redraw</button>
        </td>
      <% end %>
    </tr>
  <% end %>
</table>